<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expense Tracker Dashboard</title>
  <link rel="stylesheet" href="/styles/common.css">
  <link rel="stylesheet" href="/styles/dashboard.css">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo">Expense Tracker</div>
      <div class="user-menu">
        <a href="/auth/logout" class="logout-btn">Logout</a>
      </div>
    </div>
  </header>

  <!-- Main Container -->
  <div class="container">
    <!-- Sidebar Navigation -->
    <div class="sidebar">
      <nav class="sidebar-nav">
        <a href="#" class="nav-item active" data-tab="overview">
          <span class="nav-item-icon">üìä</span>
          Overview
        </a>
        <a href="#" class="nav-item" data-tab="expenses">
          <span class="nav-item-icon">üí∞</span>
          Expenses
        </a>
        <a href="#" class="nav-item" data-tab="categories">
          <span class="nav-item-icon">üè∑Ô∏è</span>
          Categories
        </a>
      </nav>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
      <!-- Overview Tab -->
      <div id="overview-tab" class="tab-content active">
        <div class="content-section">
          <div class="section-header">
            <p class="section-description">Get a quick summary of your expense tracking data</p>
          </div>
          
          <!-- Statistics Cards -->
          <div class="overview-grid">
            <div class="stat-card">
              <div class="stat-value" id="overview-total-expenses">‚Çπ0</div>
              <div class="stat-label">Total This Month</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="overview-expense-count">0</div>
              <div class="stat-label">Transactions</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="overview-avg-expense">‚Çπ0</div>
              <div class="stat-label">Daily Average</div>
            </div>
          </div>

          <!-- Monthly Breakdown Section -->
          <div class="content-section">
            <div class="section-header">
              <h2 class="section-title">üìà Monthly Breakdown</h2>
              <p class="section-description">View your expenses by month</p>
            </div>
            
            <div class="monthly-breakdown-grid" id="monthly-breakdown">
              <!-- Monthly cards will be populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>

      <!-- Expenses Tab -->
      <div id="expenses-tab" class="tab-content">
        <div class="content-section">
          <div class="section-header">
            <p class="section-description">Add new expenses and view your transaction history</p>
          </div>
          
          <div class="expense-actions">
            <!-- Add Expense Card -->
            <div class="card">
              <h2 class="card-title">‚ûï Add New Expense</h2>
              <form id="expense-form" class="expense-form">
                <div class="form-group">
                  <label class="form-label">Date</label>
                  <input type="date" id="date" class="form-input" required />
                </div>
                <div class="form-group">
                  <label class="form-label">Amount (‚Çπ)</label>
                  <input type="number" id="amount" class="form-input" placeholder="Enter amount" required step="0.01" />
                </div>
                <div class="form-group">
                  <label class="form-label">Category</label>
                  <select id="category" class="form-select" required>
                    <option value="" disabled selected>Select category</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label" style="opacity: 0;">Action</label>
                  <button type="submit" class="btn btn-primary">Add</button>
                </div>
              </form>
            </div>

            <!-- Recent Expenses Card -->
            <div class="card">
              <h2 class="card-title">üí∏ Recent Expenses</h2>
              
              <!-- View Controls -->
              <div class="view-controls">
                <div class="form-group" style="margin: 0;">
                  <label class="form-label">Year:</label>
                  <select id="view-year" class="form-select" style="width: auto;">
                    <!-- Populated dynamically by JavaScript -->
                  </select>
                </div>
                <div class="form-group" style="margin: 0;">
                  <label class="form-label">Month:</label>
                  <select id="view-month" class="form-select" style="width: auto;">
                    <option value="January">January</option>
                    <option value="February">February</option>
                    <option value="March">March</option>
                    <option value="April">April</option>
                    <option value="May">May</option>
                    <option value="June">June</option>
                    <option value="July">July</option>
                    <option value="August">August</option>
                    <option value="September">September</option>
                    <option value="October">October</option>
                    <option value="November">November</option>
                    <option value="December">December</option>
                  </select>
                </div>
                <button onclick="fetchExpenses()" class="btn btn-primary">Load Expenses</button>
              </div>

              <!-- Expenses Table -->
              <table class="expense-table">
                <thead>
                  <tr>
                    <th>üìÖ Date</th>
                    <th>üí∞ Amount</th>
                    <th>üè∑Ô∏è Category</th>
                  </tr>
                </thead>
                <tbody id="expense-table-body">
                  <tr>
                    <td colspan="3" class="loading">Loading expenses...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Categories Tab -->
      <div id="categories-tab" class="tab-content">
        <div class="content-section">
          <div class="section-header">
            <p class="section-description">Manage your expense categories. Add, edit, or delete categories to organize your expenses.</p>
          </div>
          
          <div class="category-management">
            <div class="card">
              <h2 class="card-title">üè∑Ô∏è Manage Categories</h2>
              
              <!-- Add Category Form -->
              <div class="category-form">
                <input type="text" id="new-category" class="form-input" placeholder="Enter new category name" required />
                <button type="button" onclick="addCategoryFromInput()" class="btn btn-success">Add</button>
              </div>
              
              <!-- Categories List -->
              <div id="custom-categories">
                <div class="loading">Loading categories...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = window.location.origin; // Use same origin in production

    // Sidebar navigation functionality
    function initializeSidebar() {
      const navItems = document.querySelectorAll('.nav-item');
      const tabContents = document.querySelectorAll('.tab-content');

      navItems.forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const tabId = item.getAttribute('data-tab');

          // Remove active class from all nav items and tab contents
          navItems.forEach(nav => nav.classList.remove('active'));
          tabContents.forEach(tab => tab.classList.remove('active'));

          // Add active class to clicked nav item and corresponding tab
          item.classList.add('active');
          document.getElementById(`${tabId}-tab`).classList.add('active');

          // Load data for specific tabs
          if (tabId === 'overview') {
            updateOverviewStatistics();
          } else if (tabId === 'expenses') {
            fetchExpenses();
          } else if (tabId === 'categories') {
            loadCategories();
          }
        });
      });
    }

    // Update statistics for overview tab
    function updateOverviewStatistics() {
      const year = new Date().getFullYear();
      
      fetch(`${API_BASE_URL}/expenses/summary?year=${year}`, {
        credentials: "include",
      })
      .then(response => {
        if (response.ok) {
          return response.json();
        }
        return {
          totalExpenses: 0,
          totalTransactions: 0,
          averagePerMonth: 0,
          thisMonthTotal: 0,
          thisMonthTransactions: 0,
          dailyAverage: 0
        };
      })
      .then(data => {
        updateOverviewDisplay(data);
      })
      .catch(error => {
        console.error("Error fetching overview data:", error);
        updateOverviewDisplay({
          totalExpenses: 0,
          totalTransactions: 0,
          averagePerMonth: 0,
          thisMonthTotal: 0,
          thisMonthTransactions: 0,
          dailyAverage: 0
        });
      });
    }

    // Update overview display with Summary sheet data
    function updateOverviewDisplay(summaryData) {
      const totalElement = document.getElementById('overview-total-expenses');
      const countElement = document.getElementById('overview-expense-count');
      const avgElement = document.getElementById('overview-avg-expense');

      if (totalElement) {
        totalElement.textContent = `‚Çπ${summaryData.thisMonthTotal.toLocaleString('en-IN', { maximumFractionDigits: 2 })}`;
      }
      if (countElement) {
        countElement.textContent = summaryData.thisMonthTransactions.toString();
      }
      if (avgElement) {
        avgElement.textContent = `‚Çπ${summaryData.dailyAverage.toLocaleString('en-IN', { maximumFractionDigits: 2 })}`;
      }

      // Update monthly breakdown
      updateMonthlyBreakdown(summaryData.monthlyBreakdown || []);
    }

    // Update monthly breakdown display
    function updateMonthlyBreakdown(monthlyData) {
      const container = document.getElementById('monthly-breakdown');
      if (!container) return;

      // If no months with expenses, show a helpful message
      if (!monthlyData || monthlyData.length === 0) {
        container.innerHTML = `
          <div class="no-data-message">
            <div class="no-data-icon">üìä</div>
            <div class="no-data-text">No monthly expenses yet</div>
            <div class="no-data-subtext">Add your first expense to see monthly breakdown</div>
          </div>
        `;
        return;
      }

      const currentMonth = new Date().toLocaleString('default', { month: 'long' });
      
      container.innerHTML = monthlyData.map(month => {
        const isCurrentMonth = month.month === currentMonth;
        const hasExpenses = month.total > 0;
        
        let cardClass = 'monthly-card';
        if (isCurrentMonth) cardClass += ' current-month';
        else if (hasExpenses) cardClass += ' has-expenses';

        return `
          <div class="${cardClass}">
            <div class="monthly-name">${month.month}</div>
            <div class="monthly-amount">‚Çπ${month.total.toLocaleString('en-IN', { maximumFractionDigits: 2 })}</div>
          </div>
        `;
      }).join('');
    }

    // Calculate and update statistics
    function updateStatistics(expenses, prefix = '') {
      const totalElement = document.getElementById(`${prefix}total-expenses`);
      const countElement = document.getElementById(`${prefix}expense-count`);
      const avgElement = document.getElementById(`${prefix}avg-expense`);

      if (!expenses || expenses.length === 0) {
        if (totalElement) totalElement.textContent = "‚Çπ0";
        if (countElement) countElement.textContent = "0";
        if (avgElement) avgElement.textContent = "‚Çπ0";
        return;
      }

      const total = expenses.reduce((sum, expense) => sum + parseFloat(expense[1] || 0), 0);
      const count = expenses.length;
      const average = count > 0 ? total / count : 0;

      if (totalElement) totalElement.textContent = `‚Çπ${total.toLocaleString('en-IN', { maximumFractionDigits: 2 })}`;
      if (countElement) countElement.textContent = count.toString();
      if (avgElement) avgElement.textContent = `‚Çπ${average.toLocaleString('en-IN', { maximumFractionDigits: 2 })}`;
    }

    // Load categories into the dropdown and categories management
    async function loadCategories() {
      try {
        const response = await fetch(`${API_BASE_URL}/categories`, {
          credentials: "include",
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const categories = await response.json();
        const categorySelect = document.getElementById("category");
        const customCategoriesDiv = document.getElementById("custom-categories");

        // Clear existing options (except the first placeholder)
        if (categorySelect) {
          categorySelect.innerHTML = '<option value="" disabled selected>Select category</option>';
          categories.forEach((category) => {
            const option = document.createElement("option");
            option.value = category.categoryName;
            option.textContent = category.categoryName;
            categorySelect.appendChild(option);
          });
        }

        // Display categories in management section
        if (customCategoriesDiv) {
          customCategoriesDiv.innerHTML = '';
          categories.forEach((category) => {
            const categoryItem = document.createElement("div");
            categoryItem.className = "category-item";
            categoryItem.innerHTML = `
              <span class="category-name">${category.categoryName}</span>
              <div class="category-actions">
                <button onclick="editCategory(${category.id}, '${category.categoryName.replace(/'/g, "\\'")}')" class="btn btn-warning">Edit</button>
                <button onclick="deleteCategory(${category.id})" class="btn btn-danger">Delete</button>
              </div>
            `;
            customCategoriesDiv.appendChild(categoryItem);
          });

          if (categories.length === 0) {
            customCategoriesDiv.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üè∑Ô∏è</div><p>No categories found. Add your first category!</p></div>';
          }
        }
      } catch (error) {
        console.error("Error loading categories:", error);
        const customCategoriesDiv = document.getElementById("custom-categories");
        if (customCategoriesDiv) {
          customCategoriesDiv.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><p>Error loading categories</p></div>';
        }
      }
    }

    // Add a new category
    async function addCategory(event) {
      event.preventDefault();
      await addCategoryFromInput();
    }

    // Delete a category
    async function deleteCategory(categoryId) {
      if (!confirm("Are you sure you want to delete this category?")) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/categories/${categoryId}`, {
          method: "DELETE",
          credentials: "include",
        });

        if (response.ok) {
          showNotification("Category deleted successfully!", "success");
          loadCategories(); // Refresh the categories
        } else {
          const errorText = await response.text();
          showNotification(`Failed to delete category: ${errorText}`, "error");
        }
      } catch (error) {
        console.error("Error deleting category:", error);
        showNotification("Error deleting category. Please try again.", "error");
      }
    }

    // Edit a category
    async function editCategory(categoryId, currentName) {
      const newName = prompt("Enter new category name:", currentName);
      
      if (!newName || newName.trim() === "" || newName.trim() === currentName) {
        return; // User cancelled or no changes
      }

      try {
        const response = await fetch(`${API_BASE_URL}/categories/${categoryId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include",
          body: JSON.stringify({ categoryName: newName.trim() }),
        });

        if (response.ok) {
          showNotification("Category updated successfully!", "success");
          loadCategories(); // Refresh the categories
        } else {
          const errorText = await response.text();
          showNotification(`Failed to update category: ${errorText}`, "error");
        }
      } catch (error) {
        console.error("Error updating category:", error);
        showNotification("Error updating category. Please try again.", "error");
      }
    }

    // Fetch and display expenses
    async function fetchExpenses() {
      try {
        const year = document.getElementById("view-year").value;
        const month = document.getElementById("view-month").value;
        
        const tableBody = document.getElementById("expense-table-body");
        tableBody.innerHTML = '<tr><td colspan="3" class="loading">Loading expenses...</td></tr>';
        
        const response = await fetch(`${API_BASE_URL}/expenses?year=${year}&month=${month}`, {
          credentials: "include", // Include cookies for session
        });
        
        if (!response.ok) {
          if (response.status === 404) {
            // Handle specific 404 errors with detailed messages
            try {
              const errorData = await response.json();
              let message = "No expenses found for this month";
              let icon = "üì≠";
              
              if (errorData.error === "no_spreadsheet") {
                message = errorData.message;
                icon = "üìä";
              } else if (errorData.error === "no_sheet") {
                message = errorData.message;
                icon = "üìù";
              }
              
              tableBody.innerHTML = `<tr><td colspan="3" class="empty-state"><div class="empty-state-icon">${icon}</div><p>${message}</p></td></tr>`;
              updateStatistics([]);
              return;
            } catch (parseError) {
              // Fallback if JSON parsing fails
              tableBody.innerHTML = '<tr><td colspan="3" class="empty-state"><div class="empty-state-icon">üì≠</div><p>No expenses found for this month</p></td></tr>';
              updateStatistics([]);
              return;
            }
          }
          
          if (response.status === 400) {
            tableBody.innerHTML = '<tr><td colspan="3" class="empty-state"><div class="empty-state-icon">üì≠</div><p>No expenses found for this month</p></td></tr>';
            updateStatistics([]);
            return;
          }
          
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        tableBody.innerHTML = ""; // Clear existing rows

        if (!data || data.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="3" class="empty-state"><div class="empty-state-icon">üì≠</div><p>No expenses found for this month</p></td></tr>';
          updateStatistics([]);
          return;
        }

        // Show newest expenses first
        const sortedExpenses = [...data].sort((a, b) => {
          const timeA = new Date(a[0]).getTime();
          const timeB = new Date(b[0]).getTime();
          if (isNaN(timeA) || isNaN(timeB)) return 0;
          return timeB - timeA;
        });

        // Populate table with expenses
        sortedExpenses.forEach((expense) => {
          const row = document.createElement("tr");
          const amount = parseFloat(expense[1] || 0);
          row.innerHTML = `
            <td>${new Date(expense[0]).toLocaleDateString('en-IN')}</td>
            <td>‚Çπ${amount.toLocaleString('en-IN', { maximumFractionDigits: 2 })}</td>
            <td><span style="background: #266663; color: white; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.85rem;">${expense[2]}</span></td>
          `;
          tableBody.appendChild(row);
        });

        // Update statistics
        updateStatistics(data);
      } catch (error) {
        console.error("Error fetching expenses:", error);
        const tableBody = document.getElementById("expense-table-body");
        tableBody.innerHTML = '<tr><td colspan="3" class="empty-state"><div class="empty-state-icon">‚ùå</div><p>Unable to load expenses. Please try again.</p></td></tr>';
        updateStatistics([]);
      }
    }

    // Add a new expense
    async function addExpense(event) {
      event.preventDefault();

      const date = document.getElementById("date").value;
      const amount = document.getElementById("amount").value;
      const category = document.getElementById("category").value;

      if (!date) {
        showNotification("Please select a date", "error");
        return;
      }

      if (!amount || parseFloat(amount) <= 0) {
        showNotification("Please enter a valid amount", "error");
        return;
      }

      if (!category) {
        showNotification("Please select a category", "error");
        return;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/expenses`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include", // Include cookies for session
          body: JSON.stringify({ date, amount: parseFloat(amount), category }),
        });

        if (response.ok) {
          document.getElementById("expense-form").reset();
          // Set today's date as default again
          document.getElementById("date").value = new Date().toISOString().split('T')[0];
          showNotification("Expense added successfully!", "success");
          fetchExpenses(); // Refresh the table
        } else {
          const errorText = await response.text();
          showNotification(`Failed to add expense: ${errorText}`, "error");
        }
      } catch (error) {
        console.error("Error adding expense:", error);
        showNotification("Error adding expense. Please try again.", "error");
      }
    }

    // Add category from input (separate from form submission)
    async function addCategoryFromInput() {
      const categoryName = document.getElementById("new-category").value.trim();

      if (!categoryName) {
        showNotification("Please enter a category name", "error");
        return;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/categories`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          credentials: "include",
          body: JSON.stringify({ categoryName }),
        });

        if (response.ok) {
          document.getElementById("new-category").value = "";
          showNotification("Category added successfully!", "success");
          loadCategories(); // Refresh the categories
        } else {
          const errorText = await response.text();
          showNotification(`Failed to add category: ${errorText}`, "error");
        }
      } catch (error) {
        console.error("Error adding category:", error);
        showNotification("Error adding category. Please try again.", "error");
      }
    }

    // Show notification
    function showNotification(message, type = "info") {
      // Remove existing notifications
      const existingNotifications = document.querySelectorAll('.notification');
      existingNotifications.forEach(n => n.remove());

      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.textContent = message;

      // Add special gradient for welcome message
      if (message.includes('Welcome to your Expense Tracker')) {
        notification.style.background = 'linear-gradient(135deg, #266663, #34d399, #10b981)';
        notification.style.boxShadow = '0 4px 20px rgba(38, 102, 99, 0.3)';
      }

      // Adjust position to avoid overlapping with logout button
      notification.style.top = '70px';

      document.body.appendChild(notification);

      // Remove notification after 4 seconds
      setTimeout(() => {
        notification.remove();
      }, 4000);
    }

    // Attach event listeners
    document.getElementById("expense-form").addEventListener("submit", addExpense);
    
    // Handle Enter key in category input
    document.getElementById("new-category").addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        addCategoryFromInput();
      }
    });

    // Initialize page
    window.onload = function() {
      // Initialize sidebar navigation
      initializeSidebar();
      
      // Set current year and month as default
      const now = new Date();
      const currentYear = now.getFullYear();
      const currentMonth = now.toLocaleString('default', { month: 'long' });
      
      const yearSelect = document.getElementById("view-year");
      const monthSelect = document.getElementById("view-month");
      const dateInput = document.getElementById("date");
      
      // Populate year dropdown dynamically (current year and 2 years back)
      if (yearSelect) {
        yearSelect.innerHTML = '';
        for (let year = currentYear; year >= currentYear - 2; year--) {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          if (year === currentYear) option.selected = true;
          yearSelect.appendChild(option);
        }
      }
      
      if (monthSelect) monthSelect.value = currentMonth;
      if (dateInput) dateInput.value = now.toISOString().split('T')[0];
      
      // Load initial data
      loadCategories();
      updateOverviewStatistics();
      
      // Show welcome notification
      setTimeout(() => {
        showNotification("Welcome to your Expense Tracker! üéâ", "success");
      }, 500);
    };
  </script>
</body>
</html>